+++
title = 'SQL slower query log : 1'
date = 2025-04-01T20:02:09+13:00
draft = false
tags = ["SQL", "SlowerQuery"]
description = ""
+++


## Query1 !!Important - TODO
```
SELECT a.*, b.name AS stateName, b.nameZh AS stateNameZh, c.partNo, c.aliasName AS componentAliasName,       c.spec AS componentSpec, c.colour AS componentColour, c.componentTypeId, c.businessTypeId, c.modelNo,        d.name AS componentTypeName, d.nameZh AS componentTypeNameZh, d.customerNo AS componentTypeNo,       f.name AS unitTypeName, f.nameZh AS unitTypeNameZh, g.orderNo AS parentOrderNo,       h.customerNo AS planCustomerNo, h.orderLineNumber AS planOrderLineNumber, h.planNo, h.extendDesc AS planDesc, h.amount, h.unitPrice, h.currencyId,       j.grossAmount, j.unmetAmount, k.demandId, l.userName AS qcCheckerNameZh, m.nameZh AS currencyNameZh       FROM companyExWarehouseOrderItem AS a, companyExWarehouseOrderState AS b, companyBasicComponent AS c, companyComponentType AS d,       companyBasicComponentBomUnitType AS f, companyExWarehouseOrder AS g, companyProductionSchedules AS h, companyProductionSchedulesBom AS j,      companyProductionDemandSchedule AS k, user AS l, currency AS m       WHERE a.parentId = 27682 AND a.sourceTypeId = 1 AND a.stateId = b.id AND a.componentId = c.id AND c.componentTypeId = d.id AND c.unitTypeId = f.id AND a.parentId = g.id AND a.scheduleId = h.id AND h.id = j.scheduleId       AND a.componentId = j.componentId AND a.scheduleId = k.scheduleId AND a.qcCheckerId = l.id AND h.currencyId = m.id;
```

before : 4.0291
code use in : solution.getSales().getTask().getExWarehouse().getItem().getListByParentId(mysqlCoon.getSlaveConn(), detailInfo.id, cb);

```
CREATE INDEX idx_exOrder_parent_source ON companyExWarehouseOrderItem (parentId, sourceTypeId);
```
then : 3.65







## Query 2

```
SELECT a.*, b.orderNo AS planNo, b.requireDate, b.requireDate AS planStartDate, f.aliasName, f.partNo, f.spec
FROM companyProductionSchedulesBom AS a, companyProductionDemandPurchaseRequirement AS b, companyBasicComponent AS f
WHERE a.companyId = 2 AND a.componentId = 917367 AND a.typeId = 0 AND a.sourceTypeId = 1 AND a.stateId = 0 AND a.unmetAmount > 0 AND a.requirementId = b.id AND b.componentId = f.id;
```
增加索引，并且顺序很重要:  
```
ALTER TABLE companyProductionSchedulesBom 
ADD INDEX idx_optimize_query (
    companyId, 
    componentId, 
    typeId, 
    sourceTypeId, 
    stateId
);
```

优化后:
**1.5 -> 0.0010**

## Query 3
```
# User@Host: etaSlave[etaSlave] @  [10.25.90.9] id: 20367468
# Query_time: 11  Lock_time: 0  Rows_sent: 0  Rows_examined: 573780
SET timestamp=1745708909
SELECT a.*, b.partNo, b.aliasName AS componentAliasName, b.spec AS componentSpec, b.componentTypeId, c.name AS componentTypeName, c.nameZh AS componentTypeNameZh, c.customerNo AS componentTypeNo, d.name AS productTypeName, d.nameZh AS productTypeNameZh, e.name AS stateName , e.nameZh AS stateNameZh,  f.name AS typeName, f.nameZh AS typeNameZh,       g.name AS basicTypeName, g.nameZh AS basicTypeNameZh, h.name AS unitTypeName, h.nameZh AS unitTypeNameZh, k.typeId AS storageBinTypeId, l.eName AS prepareUserName, l.userName AS prepareUserNameZh       FROM warehousingRecode AS a, companyBasicComponent AS b, companyComponentType AS c, warehousingRecodeProductType AS d , warehousingRecodeState AS e, materialRequirementType AS f, materialRequirementBasicType AS g, companyBasicComponentBomUnitType AS h,companyWarehouse AS j, warehouseStorageBinLevelTag AS k, user AS l        WHERE a.relationNo = 'DX-SP-2504190007' AND a.typeId = 2 AND a.componentId = b.id AND b.componentTypeId = c.id  AND a.productTypeId = d.id AND a.stateId = e.id AND a.typeId = f.id AND a.basicTypeId = g.id AND b.unitTypeId = h.id AND a.storageBinId != 0 AND a.storageBinId = j.id AND j.levelTagId = k.id AND a.prepareUserId = l.id;
```

```
CREATE INDEX idx_warehousingRecode_main ON warehousingRecode (relationNo, typeId, componentId, productTypeId, stateId, basicTypeId, storageBinId, prepareUserId);
```
优化后:
**1.5 -> 0.0010**

## Query 4 - TODO
```
SELECT COUNT(1) AS count, left(completeDate, 7 ) AS month FROM companyProductionSchedules
WHERE companyId = 2 AND stateId = 2 AND id IN (SELECT scheduleId FROM companyProductionSchedulesBom WHERE companyId = 2 AND metAmount > 0 AND typeId = 1  GROUP BY scheduleId)
GROUP BY left(completeDate, 7 ) ORDER BY month DESC;
```

## Query 5
```
# Query_time: 16  Lock_time: 0  Rows_sent: 19  Rows_examined: 1828418
SET timestamp=1745806675
SELECT relationNo, SUM(numbers) AS numbers FROM warehousingRecode WHERE typeId IN (3, 5) AND relationNo IN ("DX-PMO-202504150003","DX-PMO-202504150485","DX-PMO-202504150487","DX-PMO-202504190152","DX-PMO-202504190446","DX-PMO-202504210639","DX-PMO-202504210814","DX-PMO-202504211563","DX-PMO-202504211706","DX-PMO-202504211717","DX-PMO-202504212095","DX-PMO-202504212103","DX-PMO-202504220110","DX-PMO-202504220186","DX-PMO-202504220188","DX-PMO-202504220189","DX-PMO-202504220203","DX-PMO-202504220216","DX-PMO-202504220219","DX-PMO-202504220220","DX-PMO-202504220221","DX-PMO-202504220363","DX-PMO-202504220368","DX-PMO-202504220369","DX-PMO-202504220371","DX-PMO-202504220375","DX-PMO-202504220376","DX-PMO-202504220378","DX-PMO-202504220379","DX-PMO-202504220415","DX-PMO-202504220450","DX-PMO-202504220490","DX-PMO-202504220493","DX-PMO-202504220544","DX-PMO-202504220607","DX-PMO-202504220608","DX-PMO-202504220609","DX-PMO-202504220610","DX-PMO-202504220611","DX-PMO-202504220612","DX-PMO-202504220613","DX-PMO-202504220614","DX-PMO-202504220615","DX-PMO-202504220616","DX-PMO-202504220618","DX-PMO-202504220619","DX-PMO-202504220620","DX-PMO-202504220621","DX-PMO-202504220622","DX-PMO-202504220628","DX-PMO-202504220630","DX-PMO-202504220633","DX-PMO-202504230003","DX-PMO-202504230072","DX-PMO-202504230094","DX-PMO-202504230435","DX-PMO-202504230447","DX-PMO-202504230489","DX-PMO-202504230516","DX-PMO-202504230520","DX-PMO-202504230521","DX-PMO-202504230523","DX-PMO-202504230557","DX-PMO-202504230558","DX-PMO-202504230608","DX-PMO-202504230697","DX-PMO-202504230714","DX-PMO-202504230716","DX-PMO-202504230717","DX-PMO-202504230718","DX-PMO-202504230719","DX-PMO-202504230723","DX-PMO-202504230724","DX-PMO-202504230726","DX-PMO-202504230727","DX-PMO-202504230728","DX-PMO-202504230730","DX-PMO-202504230732","DX-PMO-202504230735","DX-PMO-202504230739","DX-PMO-202504230740","DX-PMO-202504230751","DX-PMO-202504230754","DX-PMO-202504230769","DX-PMO-202504230770","DX-PMO-202504230778","DX-PMO-202504230781","DX-PMO-202504230785","DX-PMO-202504230810","DX-PMO-202504230811","DX-PMO-202504230812","DX-PMO-202504230813","DX-PMO-202504230918","DX-PMO-202504231013","DX-PMO-202504231067","DX-PMO-202504231072","DX-PMO-202504231084","DX-PMO-202504231085","DX-PMO-202504231086","DX-PMO-202504231277","DX-PMO-202504231353","DX-PMO-202504231553","DX-PMO-202504231611","DX-PMO-202504231740","DX-PMO-202504231746","DX-PMO-202504231809","DX-PMO-202504231838","DX-PMO-202504231888","DX-PMO-202504231892","DX-PMO-202504231991","DX-PMO-202504231993","DX-PMO-202504231996","DX-PMO-202504232000","DX-PMO-202504232006","DX-PMO-202504232023","DX-PMO-202504232042","DX-PMO-202504232059","DX-PMO-202504232099","DX-PMO-202504233040","DX-PMO-202504233044","DX-PMO-202504233242","DX-PMO-202504233356","DX-PMO-202504233363","DX-PMO-202504233443","DX-PMO-202504233580","DX-PMO-202504233723","DX-PMO-202504233724","DX-PMO-202504233977","DX-PMO-202504234115","DX-PMO-202504234487","DX-PMO-202504234611","DX-PMO-202504234612","DX-PMO-202504234613","DX-PMO-202504234614","DX-PMO-202504234615","DX-PMO-202504234616","DX-PMO-202504234617","DX-PMO-202504234620","DX-PMO-202504234621","DX-PMO-202504234622","DX-PMO-202504234623","DX-PMO-202504234624","DX-PMO-202504234625","DX-PMO-202504234833","DX-PMO-202504234841","DX-PMO-202504234895","DX-PMO-202504234924","DX-PMO-202504234941","DX-PMO-202504234954","DX-PMO-202504234971","DX-PMO-202504235214","DX-PMO-202504235215","DX-PMO-202504235216","DX-PMO-202504235219","DX-PMO-202504235227","DX-PMO-202504235228","DX-PMO-202504235229","DX-PMO-202504235230","DX-PMO-202504235239","DX-PMO-202504235240","DX-PMO-202504235241","DX-PMO-202504235242","DX-PMO-202504235243","DX-PMO-202504235244","DX-PMO-202504235245","DX-PMO-202504235247","DX-PMO-202504235248","DX-PMO-202504235249","DX-PMO-202504235250","DX-PMO-202504235251","DX-PMO-202504235252","DX-PMO-202504235253","DX-PMO-202504235254","DX-PMO-202504235255","DX-PMO-202504235256","DX-PMO-202504235257","DX-PMO-202504235258","DX-PMO-202504235259","DX-PMO-202504235260","DX-PMO-202504235261","DX-PMO-202504235262","DX-PMO-202504235263","DX-PMO-202504235264","DX-PMO-202504235265","DX-PMO-202504235266","DX-PMO-202504235267","DX-PMO-202504235268","DX-PMO-202504235269","DX-PMO-202504235270","DX-PMO-202504235271","DX-PMO-202504235272","DX-PMO-202504235273","DX-PMO-202504235274","DX-PMO-202504235275","DX-PMO-202504235276","DX-PMO-202504235277","DX-PMO-202504235278","DX-PMO-202504235279","DX-PMO-202504235280","DX-PMO-202504235281","DX-PMO-202504235282","DX-PMO-202504235283","DX-PMO-202504235284","DX-PMO-202504235285","DX-PMO-202504235286","DX-PMO-202504235287","DX-PMO-202504235288","DX-PMO-202504235289","DX-PMO-202504235290","DX-PMO-202504235291","DX-PMO-202504235292","DX-PMO-202504235293","DX-PMO-202504235294","DX-PMO-202504235295","DX-PMO-202504235296","DX-PMO-202504235297","DX-PMO-202504235298","DX-PMO-202504235300","DX-PMO-202504235301","DX-PMO-202504235302","DX-PMO-202504235303","DX-PMO-202504235304","DX-PMO-202504235305","DX-PMO-202504235306","DX-PMO-202504235307","DX-PMO-202504235308","DX-PMO-202504235309","DX-PMO-202504235310","DX-PMO-202504235311","DX-PMO-202504235312","DX-PMO-202504235313","DX-PMO-202504235315","DX-PMO-202504235316","DX-PMO-202504235319","DX-PMO-202504235320","DX-PMO-202504235321","DX-PMO-202504235322","DX-PMO-202504235323","DX-PMO-202504235324","DX-PMO-202504235327","DX-PMO-202504235328","DX-PMO-202504235329","DX-PMO-202504235330","DX-PMO-202504235331","DX-PMO-202504235332","DX-PMO-202504235333","DX-PMO-202504235334","DX-PMO-202504235335","DX-PMO-202504235336","DX-PMO-202504235337","DX-PMO-202504235338","DX-PMO-202504235339","DX-PMO-202504235340","DX-PMO-202504235341","DX-PMO-202504235342","DX-PMO-202504235343","DX-PMO-202504235344","DX-PMO-202504235345","DX-PMO-202504235346","DX-PMO-202504235347","DX-PMO-202504235348","DX-PMO-202504235349","DX-PMO-202504235350","DX-PMO-202504235351","DX-PMO-202504235352","DX-PMO-202504235353","DX-PMO-202504235355","DX-PMO-202504235356","DX-PMO-202504235357","DX-PMO-202504235358","DX-PMO-202504235359","DX-PMO-202504235360","DX-PMO-202504235361","DX-PMO-202504235362","DX-PMO-202504235363","DX-PMO-202504235365","DX-PMO-202504235366","DX-PMO-202504235367","DX-PMO-202504235368","DX-PMO-202504235369","DX-PMO-202504235370","DX-PMO-202504235371","DX-PMO-202504235372","DX-PMO-202504235373","DX-PMO-202504235374","DX-PMO-202504235375","DX-PMO-202504235376","DX-PMO-202504235377","DX-PMO-202504235378","DX-PMO-202504235379","DX-PMO-202504235380","DX-PMO-202504235381","DX-PMO-202504235382","DX-PMO-202504240205","DX-PMO-202504240209","DX-PMO-202504240210","DX-PMO-202504240211","DX-PMO-202504240212","DX-PMO-202504240294","DX-PMO-202504240305","DX-PMO-202504240337","DX-PMO-202504240338","DX-PMO-202504240344","DX-PMO-202504240346","DX-PMO-202504240347","DX-PMO-202504240376","DX-PMO-202504250003","DX-PMO-202504250004","DX-PMO-202504250005","DX-PMO-202504250006","DX-PMO-202504250007","DX-PMO-202504250008","DX-PMO-202504250009","DX-PMO-202504250010","DX-PMO-202504250012","DX-PMO-202504250013","DX-PMO-202504250014","DX-PMO-202504250015","DX-PMO-202504250016","DX-PMO-202504250017","DX-PMO-202504250018","DX-PMO-202504250019","DX-PMO-202504250022","DX-PMO-202504250023","DX-PMO-202504250025","DX-PMO-202504250099","DX-PMO-202504250102","DX-PMO-202504250104","DX-PMO-202504250105","DX-PMO-202504250120","DX-PMO-202504250155","DX-PMO-202504250156","DX-PMO-202504250157","DX-PMO-202504250166","DX-PMO-202504250189","DX-PMO-202504250190","DX-PMO-202504250199","DX-PMO-202504250213","DX-PMO-202504250214","DX-PMO-202504270088","DX-PMO-202504270089","DX-PMO-202504270090","DX-PMO-202504270091","DX-PMO-202504270092","DX-PMO-202504270093","DX-PMO-202504270094","DX-PMO-202504270095","DX-PMO-202504270097","DX-PMO-202504270114","DX-PMO-202504270144","DX-PMO-202504270161","DX-PMO-202504270196","DX-PMO-202504270197","DX-PMO-202504270198","DX-PMO-202504270199","DX-PMO-202504270200","DX-PMO-202504270201","DX-PMO-202504270202","DX-PMO-202504270203","DX-PMO-202504270204","DX-PMO-202504270205","DX-PMO-202504270206","DX-PMO-202504270207","DX-PMO-202504270211","DX-PMO-202504270213") GROUP BY relationNo;
# Time: 2025-04-28T10:17:56.249977 CST
```

## QUery 6
```
# Time: 2025-04-28T11:53:18.675913 CST
# User@Host: etaSlave[etaSlave] @  [10.25.90.9] id: 20367468
# Query_time: 6  Lock_time: 0  Rows_sent: 1  Rows_examined: 365728
SET timestamp=1745812398
SELECT a.*, b.name AS stateName, b.nameZh AS stateNameZh, c.eName AS userName, c.userName AS userNameZh, d.name AS procedureName, d.nameZh AS procedureNameZh,     e.workshopId, e.name AS workCenterName, e.nameZh AS workCenterNameZh, f.eName AS workCenterManagerName, f.userName AS workCenterManagerNameZh,     h.planNo AS schedulePlanNo, h.requireDate AS scheduleRequireDate, h.netAmount, h.bomId, h.componentId, k.partNo, k.componentTypeId, k.aliasName AS componentAliasName, k.spec AS componentSpec,     l.customerNo AS componentTypeNo, l.nameZh AS componentTypeNameZh, l.name AS componentTypeName, m.procedureWagesTypeId, m.id AS componentProcedureId, m.estimateTimePrice, m.totalCost, m.cost, n.nameZh AS teamNameZh     FROM `companyProductionSchedulesTask` AS a, `companyProductionSchedulesTaskState` AS b, `user` AS c, meProcedure AS d, pmcWorkshopProductionLine AS e, user AS f,     companyProductionSchedules AS h, companyBasicComponent AS k, companyComponentType AS l, companyComponentTechnicProcedure AS m, companyWorkshopTeam AS n     WHERE a.companyId = 2  AND a.stateId = 0 AND a.id NOT IN (SELECT taskId FROM workshopByTimeWagesApply WHERE companyId = 2 AND id != 29645 ) AND a.stateId = b.id AND a.userId = c.id AND a.procedureId = d.id AND a.workCenterId = e.id AND a.workCenterManagerId = f.id AND e.workshopId = 5     AND a.schedulesId = h.id AND h.componentId = k.id AND k.componentTypeId = l.id AND a.procedureId = m.procedureId AND m.procedureWagesTypeId = 2 AND h.componentId = m.componentId AND a.teamId = n.id AND a.completeDate >= '2025-03-29' AND a.completeDate <= '2025-04-29';
```
